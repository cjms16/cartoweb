<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"
     integrity="sha256-kLaT2GOSpHechhsozzB+flnD+zUyjE2LlfWPgU04xyI="
     crossorigin=""/>
     <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
     integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">

     <!-- Pour le routing : -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.2.0/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />
    <!--  -->
    <link rel="icon" href="assets/favicon.png">

    <title>CartoWeb - Projet</title>
    <style>
        #map {
            height: 850px; width: 100%;
            border: 1px solid black;
        }
        /* Pour cacher la box avec les consignes de navigation */
        .leaflet-routing-container {
            display: none;
        }
    </style>

</head>
<body>
     <!-- JS de  Leaflet -->
    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js" integrity="sha256-WBkoXOwTeyKclOHuWtc+i2uENFpDZ9YPdf5Hf+D7ewM=" crossorigin=""></script>

    <!-- JS du Routing Leaflet -->
    <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.AnimatedMarker/1.0.0/AnimatedMarker.min.js" integrity="sha512-Ir8s06d1S4H5J8LmeAHblNVEPkyYgA5AmOUba/xlNbFGTeDRqxAMBE1jp5PycEwKZ6FzuYsj22q/sDs0LCuSrA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <script src="cartoweb_functions.js"></script>

    <div class="container-fluid">
        <div class="row">
            <div class="col-9" id="left-div">
                <div id="map"></div>
            </div>
            <div class="col-3" id="right-div">
                <img src="assets/logo-off.png" alt="logo-titre">
                <p id="position-display"></p>
                <p id="hexagon-display"></p>

                <div class="container-fluid form-group">
                    <label for="num-routes" class="col-form-label">Nombre d'itinéraires:</label>
                    <select id="num-routes" class="form-control">
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                    </select>
                    <br>
                    <button id="btn-start-animation" class="btn btn-success">Démarrer</button>
                    <button id="btn-pause-animation" class="btn btn-secondary">Pause</button>
                    <button id="btn-stop-animation" class="btn btn-danger">Stopper</button>
                </div>
            </div>
        </div>
    </div>

    <script>

    const CENTRE_MULHOUSE = { lat: 47.7496926, lng: 7.3372857 };
    const RAYON_ZONE_DEPLACEMENT = 3;
    const VITESSE_DEPLACEMENT = 1000;

    var map = L.map('map').setView([CENTRE_MULHOUSE.lat, CENTRE_MULHOUSE.lng], 13);

    const corner1 = L.latLng(47.787327, 7.253229);
    const corner2 = L.latLng(47.705142, 7.430711);
    grille_mulhouse = L.latLngBounds(corner1, corner2);

    L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
    }).addTo(map);

    // Utiliser la fonction pour générer points aléatoire de départ et d'arrivée
    var startPoint = generateRandomPoint(CENTRE_MULHOUSE.lat, CENTRE_MULHOUSE.lng);
    var endPoint = generateRandomPoint(CENTRE_MULHOUSE.lat, CENTRE_MULHOUSE.lng);

    //Ajout d'un itineraire entre les deux points AVEC CONTROL
    var routeControl = L.Routing.control({
            waypoints: [
                startPoint,
                endPoint
            ],
            show: false,
            //collapsed: true //pour cacher le segment
        }).addTo(map);

    //Gestionnaire d'évènements pour récupérer tous les points de l'itinéraire (mais qui nous bloque dans le gestionnaire car indispo en dehors)
    routeControl.on('routeselected', function(e) {
        var route = e.route;
        routeArray = route.coordinates;

        for (var i = 0; i < routeArray.length; i++) {
            var point = routeArray[i];
            //var circle = L.circleMarker(point, {radius: 5}).addTo(map);
        }

        var voiture1 = L.animatedMarker(
            routeArray,
            {
                distance: 1000, // Distance parcourue en millisecondes
                interval: 200, // Intervalle entre les positions en millisecondes
                icon: L.icon({
                    iconUrl: 'assets/marker-icon.png',
                    iconSize: [25, 41],
                    iconAnchor: [12, 41],
                    // shadowUrl: 'assets/marker-shadow.png',
                    shadowSize: [41, 41],
                    shadowAnchor: [12, 41],
                    iconBorderColor: '#444'
                }),
                autoStart: true, // Démarrer automatiquement l'animation
                onEnd: function() {
                console.log("Trajet terminée !");
                }
            }
        );
        voiture1.addTo(map);

        const squareGrid = createHexGrid(grille_mulhouse, 0.005);

        //MAJ la position de l'animated marker sur le volet stat && MAJ couleur polygones
        function updatePositionDisplay() {
            var coords = voiture1.getLatLng();
            document.getElementById("position-display").innerHTML = "Latitude : " + coords.lat + ", Longitude : " + coords.lng;
        }

        function updateHexagonColor() {
            for (let i = 0; i < squareGrid.length; i++) {
                const hex = squareGrid[i].getBounds();
                if (hex.contains(voiture1.getLatLng())) { //if(isMarkerInsidePolygon(voiture1.getLatLng().lat,voiture1.getLatLng().lng, squareGrid[i])) {
                    squareGrid[i].setStyle({fillColor: 'green'});
                    document.getElementById("hexagon-display").innerHTML = "Index de l'hexagone : " + i;
                } else {
                    squareGrid[i].setStyle({fillColor: 'gray'});
                }
            }
        }

        // maj de la position toutes les 0.1 secondes
        setInterval(updatePositionDisplay, 100);
        setInterval(updateHexagonColor, 100);

    });

    </script>

</body>
</html>